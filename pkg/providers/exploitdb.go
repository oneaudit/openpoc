package providers

import (
	"bytes"
	"encoding/csv"
	"fmt"
	"io"
	"openpoc/pkg/types"
	"os"
	"strings"
)

func ParseExploitDB(csvFilePath string) ([]*types.ExploitDB, error) {
	file, err := os.ReadFile(csvFilePath)
	if err != nil {
		return nil, err
	}

	// .csv
	csvReader := csv.NewReader(bytes.NewReader(file))
	csvReader.Comma = ','
	csvReader.FieldsPerRecord = 17

	firstLine := true
	var records []*types.ExploitDB
	for {
		record, err := csvReader.Read()
		if err == io.EOF {
			break
		}
		if firstLine {
			firstLine = false
			continue
		}
		if err != nil {
			return nil, err
		}

		codes := strings.Split(record[11], ";")
		cveID := ""
		for _, code := range codes {
			code = strings.ToUpper(code)
			if strings.HasPrefix(code, "CVE-") && code != "CVE-NA" {
				cveID = code
				break
			}
		}

		if cveID == "" {
			continue
		}

		if strings.Contains(cveID, "cve : ") {
			cveID = strings.Replace(cveID, "cve : ", "", 1)
		}

		records = append(records, &types.ExploitDB{
			Cve:         cveID,
			URL:         fmt.Sprintf("https://www.exploit-db.com/exploits/%s", record[0]),
			AddedAt:     record[3],
			Trustworthy: true,
		})
	}
	return records, nil
}
